!function(e){"use strict"
function t(e){return parseInt(e.replace(/px|%/,""),10)}var n=navigator.userAgent.toLowerCase().indexOf("firefox")>-1
e.module("scrollable-table",[]).directive("scrollableTable",["$timeout","$q","$parse",function(i,r,l){return{transclude:!0,restrict:"E",scope:{rows:"=watch",sortFn:"="},template:'<div class="scrollableContainer"><div class="headerSpacer"></div><div class="scrollArea preventPageScroll" ng-transclude></div></div>',controller:["$scope","$element","$attrs",function(s,a,o){function c(e,t){var n=s.sortExpr.match(/(.+)\s+as\s+(.+)/),i={}
i[n[1]]=e
var r=l(n[2])(i)
i[n[1]]=t
var a=l(n[2])(i)
return r===a?0:r>a?1:-1}function d(e){var t=a.find(".headerSpacer").height(),n=a.find(".scrollArea").scrollTop()
a.find(".scrollArea").scrollTop(n+e.position().top-t)}function h(){function e(){0===a.find("table:visible").length?i(e,100):t.resolve()}var t=r.defer()
return i(e),t.promise}function f(){a.find("thead th .th-inner").length||a.find("thead th").wrapInner('<div class="th-inner"></div>'),a.find("thead th .th-inner:not(:has(.box))").length&&a.find("thead th .th-inner:not(:has(.box))").wrapInner('<div class="box"></div>'),a.find("table th .th-inner:visible").each(function(n,i){i=e.element(i)
var r=i.parent().width(),l=a.find("table th:visible:last"),s=r
if("center"!==l.css("text-align")){var o=a.find(".scrollArea").height()<a.find("table").height()
l[0]==i.parent()[0]&&o&&(s+=a.find(".scrollArea").width()-a.find("tbody tr").width(),s=Math.max(s,r))}var c=t(i.parent().css("min-width")),d=i.parent().attr("title")
s=Math.max(c,s),i.css("width",s),d||(d=i.find(".title .ng-scope").text()||i.find(".box").text()),i.attr("title",d.trim())}),v.resolve()}function u(){for(var e=h().then(f),t=s.headerResizeHanlers||[],n=0;n<t.length;n++)e=e.then(t[n])
return e}this.getSortExpr=function(){return s.sortExpr},this.isAsc=function(){return s.asc},this.setSortExpr=function(e){s.asc=!0,s.sortExpr=e},this.toggleSort=function(){s.asc=!s.asc},this.doSort=function(e){e?s.rows.sort(function(t,n){var i=e(t,n)
return s.asc?i:i*-1}):s.rows.sort(function(e,t){var n=c(e,t)
return s.asc?n:n*-1})},this.renderTalble=function(){return h().then(f)},this.getTableElement=function(){return a},this.appendTableResizingHandler=function(e){for(var t=s.headerResizeHanlers||[],n=0;n<t.length;n++)if(t[n].name===e.name)return
t.push(e),s.headerResizeHanlers=t},s.$on("rowSelected",function(e,t){var n=a.find(".scrollArea table tr[row-id='"+t+"']")
1===n.length&&r.all([h(),v.promise]).then(function(){d(n)})})
var v=r.defer()
s.$watch("rows",function(e,t){e&&(u(a.find(".scrollArea").width()),s.sortExpr=null,a.find(".scrollArea").scrollTop(0))}),s.asc=!o.hasOwnProperty("desc"),s.sortAttr=o.sortAttr
var p=n?"thead":"thead th .th-inner"
a.find(".scrollArea").scroll(function(e){a.find(p).css("margin-left",0-e.target.scrollLeft)}),s.$on("renderScrollableTable",function(){u(a.find(".scrollArea").width())}),e.element(window).on("resize",function(){i(function(){s.$apply()})}),s.$watch(function(){return a.find(".scrollArea").width()},function(e,t){e*t<=0||u()})}]}}]).directive("sortableHeader",[function(){return{transclude:!0,scope:!0,require:"^scrollableTable",template:'<div class="box"><div ng-mouseenter="enter()" ng-mouseleave="leave()"><div class="title" ng-transclude></div><span class="orderWrapper"><span class="order" ng-show="focused || isActive()" ng-click="toggleSort($event)" ng-class="{active:isActive()}"><i ng-show="isAscending()" class="glyphicon glyphicon-chevron-up"></i><i ng-show="!isAscending()" class="glyphicon glyphicon-chevron-down"></i></span></span></div></div>',link:function(t,n,i,r){var l=i.on||"a as a."+i.col
t.element=e.element(n),t.isActive=function(){return r.getSortExpr()===l},t.toggleSort=function(e){t.isActive()?r.toggleSort():r.setSortExpr(l),r.doSort(t[i.comparatorFn]),e.preventDefault()},t.isAscending=function(){return!(!t.focused||t.isActive())||r.isAsc()},t.enter=function(){t.focused=!0},t.leave=function(){t.focused=!1},t.isLastCol=function(){return n.parent().find("th:last-child").get(0)===n.get(0)}}}}]).directive("resizable",["$compile",function(n){return{restrict:"A",priority:0,scope:!1,require:"scrollableTable",link:function(i,r,l,s){function a(){var t=r.find("table th:not(:last-child) .th-inner")
if(0==t.find(".resize-rod").length){s.getTableElement().find(".scrollArea table").css("table-layout","auto")
var l=e.element('<div class="resize-rod" ng-mousedown="resizing($event)"></div>')
t.append(n(l)(i))}}function o(){var n=s.getTableElement(),i=1
n.find("table th .th-inner:visible").each(function(n,r){r=e.element(r)
var l=r.parent().width(),s=t(r.parent().css("min-width"))
l=Math.max(s,l),r.css("left",i),i+=l})}function c(){var n=1,i=s.getTableElement()
s.getTableElement().find("table th .th-inner:visible").each(function(r,l){l=e.element(l)
var s=l.parent().width(),a=i.find("table th:visible:last"),o=t(l.parent().css("min-width"))
s=Math.max(o,s),a[0]!=l.parent()[0]&&l.parent().css("width",s),l.css("left",n),n+=s})}function d(n){var i=s.getTableElement(),r=i.find("table th:visible").length,l=i.find("table th:visible:last")
i.find("table th:visible").each(function(i,s){if(s=e.element(s),l.get(0)==s.get(0))return void s.css("width","auto")
var a=s.data("width")
a=/\d+%$/.test(a)?Math.ceil(n*t(a)/100):n/r,s.css("width",a+"px")}),s.renderTalble().then(c())}s.appendTableResizingHandler(function(){a()}),s.appendTableResizingHandler(function(){var e=s.getTableElement().find(".scrollArea table")
"auto"===e.css("table-layout")?o():d(e.parent().width())}),i.resizing=function(n){var i=s.getTableElement().find(".scrollArea").scrollLeft(),r=e.element(n.target).parent(),l=r.parent(),a=t(r.css("left"))+r.width()-i,o=n.pageX,d=e.element(document),h=e.element("body"),f=e.element(".scrollableContainer .resizing-cover"),u=e.element('<div class="scaler">')
h.addClass("scrollable-resizing"),f.addClass("active"),e.element(".scrollableContainer").append(u),u.css("left",a),d.bind("mousemove",function(e){var n=e.pageX-o,i=t(u.css("left"))-a,r=l.width(),s=l.nextAll("th:visible").first(),c=t(l.css("min-width")),d=s.width(),h=t(s.css("min-width"))
o=e.pageX,e.preventDefault(),n>0&&d-i<=h||n<0&&r+i<=c||u.css("left",t(u.css("left"))+n)}),d.bind("mouseup",function(n){n.preventDefault(),u.remove(),h.removeClass("scrollable-resizing"),f.removeClass("active"),d.unbind("mousemove"),d.unbind("mouseup")
var i=t(u.css("left"))-a,r=l.width(),o=t(l.css("min-width")),v=l.nextAll("th:visible").first(),p=v.width(),g=t(v.css("min-width")),b=s.getTableElement().find(".scrollArea table")
"auto"===b.css("table-layout")&&b.find("th .th-inner").each(function(t,n){n=e.element(n)
var i=n.parent().width()
n.parent().css("width",i)}),b.css("table-layout","fixed"),i>0&&p-i<=g&&(i=p-g),v.removeAttr("style"),r+=i,l.css("width",Math.max(o,r)),v.css("width",p-i),s.renderTalble().then(c())})}}}}]).directive("preventPageScroll",[function(){return{restrict:"C",scope:{endofpage:"="},link:function(e,t){t.bind("mousewheel",function(t){console.log("Prevent the scroll!")
var n=this.offsetHeight-this.clientHeight,i=this.scrollHeight-this.offsetHeight+n;(this.scrollTop===i&&0!=this.scrollTop&&t.originalEvent.deltaY>0||this.scrollTop!=i&&0==this.scrollTop&&t.originalEvent.deltaY<0)&&(t.preventDefault(),t.deltaY>0&&e.endofpage())})}}}])}(angular)
